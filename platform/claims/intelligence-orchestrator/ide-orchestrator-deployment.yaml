apiVersion: platform.bizmatters.io/v1alpha1
kind: WebService
metadata:
  name: ide-orchestrator
  namespace: intelligence-orchestrator
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  image: ide-orchestrator:ci-test
  port: 8080
  size: micro
  hostname: "api.local.bizmatters.com"
  pathPrefix: "/api"
  
  # Enhanced backend service discovery
  backendServiceName: "deepagents-runtime-http"
  backendServicePort: 8000
  backendServiceNamespace: "intelligence-deepagents"  # Cross-namespace service reference
  sessionAffinity: "ClientIP"
  
  # Database configuration
  databaseName: "ide_orchestrator"
  
  # Functional Init container - wait for database connectivity
  initContainer:
    command: ["/bin/sh", "-c"]
    args: 
      - |
        echo "Waiting for database to accept connections..."
        # Check every 2 seconds if the port is open
        until nc -z $POSTGRES_HOST $POSTGRES_PORT; do
          echo "Database at $POSTGRES_HOST:$POSTGRES_PORT is not ready yet..."
          sleep 2
        done
        echo "âœ… Database is reachable!"
  
  # Secrets with standard environment variable names (envFrom)
  secret1Name: ide-orchestrator-db-conn      # POSTGRES_HOST, POSTGRES_PORT, POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD
  secret2Name: ide-orchestrator-jwt-keys     # JWT_SECRET_KEY, JWT_ALGORITHM
  secret3Name: ide-orchestrator-app-secrets  # Additional application secrets