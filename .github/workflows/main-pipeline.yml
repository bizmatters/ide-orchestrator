name: "Build Once, Validate Many, Release One"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  id-token: write      # Required for AWS OIDC authentication in ci-test.yml
  contents: read       # Required for checkout actions
  pull-requests: write # Required for test reporting

jobs:
  # STAGE 1: Build artifact once
  build:
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-build.yml@main
    with:
      service_name: ide-orchestrator
    secrets:
      BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}

  # STAGE 2: Parallel tests using same artifact
  test-auth:
    needs: build
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-test.yml@main
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      test_suite: "tests/integration/test_auth_integration.py"
      test_name: "auth"
      timeout: 30
    secrets:
      BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
      BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      TENANTS_REPO_NAME: ${{ secrets.TENANTS_REPO_NAME }}
      IDEO_JWT_SECRET: ${{ secrets.IDEO_JWT_SECRET }}
      IDEO_SPEC_ENGINE_URL: ${{ secrets.IDEO_SPEC_ENGINE_URL }}

  test-auth-db:
    needs: build
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-test.yml@main
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      test_suite: "tests/integration/test_auth_db_integration.py"
      test_name: "auth-db"
      timeout: 30
    secrets:
      BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
      BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      TENANTS_REPO_NAME: ${{ secrets.TENANTS_REPO_NAME }}
      IDEO_JWT_SECRET: ${{ secrets.JWT_SECRET }}
      IDEO_SPEC_ENGINE_URL: ${{ secrets.SPEC_ENGINE_URL }}

  test-auth-jwt:
    needs: build
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-test.yml@main
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      test_suite: "tests/integration/test_jwt_validation_integration.py"
      test_name: "auth-jwt"
      timeout: 30
    secrets:
      BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
      BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      TENANTS_REPO_NAME: ${{ secrets.TENANTS_REPO_NAME }}
      IDEO_JWT_SECRET: ${{ secrets.JWT_SECRET }}
      IDEO_SPEC_ENGINE_URL: ${{ secrets.SPEC_ENGINE_URL }}

  test-workflow:
    needs: build
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-test.yml@main
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      test_suite: "tests/integration/test_workflow_integration.py"
      test_name: "workflow"
      timeout: 30
    secrets:
      BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
      BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      TENANTS_REPO_NAME: ${{ secrets.TENANTS_REPO_NAME }}
      IDEO_JWT_SECRET: ${{ secrets.IDEO_JWT_SECRET }}
      IDEO_SPEC_ENGINE_URL: ${{ secrets.IDEO_SPEC_ENGINE_URL }}

  test-integration:
    needs: build
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-test.yml@main
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      test_suite: "tests/integration/test_refinement_integration.py"
      test_name: "integration"
      timeout: 30
    secrets:
      BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
      BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      TENANTS_REPO_NAME: ${{ secrets.TENANTS_REPO_NAME }}
      IDEO_JWT_SECRET: ${{ secrets.JWT_SECRET }}
      IDEO_SPEC_ENGINE_URL: ${{ secrets.SPEC_ENGINE_URL }}

  test-refinement-lifecycle-approved:
    needs: build
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-test.yml@main
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      test_suite: "tests/integration/refinement/test_refinement_approved.py"
      test_name: "refinement-lifecycle-approved"
      timeout: 30
    secrets:
      BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
      BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      TENANTS_REPO_NAME: ${{ secrets.TENANTS_REPO_NAME }}
      IDEO_JWT_SECRET: ${{ secrets.JWT_SECRET }}
      IDEO_SPEC_ENGINE_URL: ${{ secrets.SPEC_ENGINE_URL }}

  test-refinement-lifecycle-rejected:
    needs: build
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-test.yml@main
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      test_suite: "tests/integration/refinement/test_refinement_rejected.py"
      test_name: "refinement-lifecycle-rejected"
      timeout: 30
    secrets:
      BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
      BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      TENANTS_REPO_NAME: ${{ secrets.TENANTS_REPO_NAME }}
      IDEO_JWT_SECRET: ${{ secrets.JWT_SECRET }}
      IDEO_SPEC_ENGINE_URL: ${{ secrets.SPEC_ENGINE_URL }}

  # Prepare secret blobs for each environment
  prepare-secrets:
    runs-on: ubuntu-latest
    outputs:
      dev_blob: ${{ steps.dev.outputs.blob }}
      staging_blob: ${{ steps.staging.outputs.blob }}
      prod_blob: ${{ steps.prod.outputs.blob }}
    steps:
      - id: dev
        run: |
          delimiter="$(openssl rand -hex 8)"
          echo "blob<<$delimiter" >> $GITHUB_OUTPUT
          echo "IDEO_DATABASE_URL=${{ secrets.DEV_IDEO_DATABASE_URL }}" >> $GITHUB_OUTPUT
          echo "IDEO_JWT_SECRET=${{ secrets.DEV_IDEO_JWT_SECRET }}" >> $GITHUB_OUTPUT
          echo "$delimiter" >> $GITHUB_OUTPUT
      
      - id: staging
        run: |
          delimiter="$(openssl rand -hex 8)"
          echo "blob<<$delimiter" >> $GITHUB_OUTPUT
          echo "IDEO_DATABASE_URL=${{ secrets.STAGING_IDEO_DATABASE_URL }}" >> $GITHUB_OUTPUT
          echo "IDEO_JWT_SECRET=${{ secrets.STAGING_IDEO_JWT_SECRET }}" >> $GITHUB_OUTPUT
          echo "$delimiter" >> $GITHUB_OUTPUT
      
      - id: prod
        run: |
          delimiter="$(openssl rand -hex 8)"
          echo "blob<<$delimiter" >> $GITHUB_OUTPUT
          echo "IDEO_DATABASE_URL=${{ secrets.PROD_IDEO_DATABASE_URL }}" >> $GITHUB_OUTPUT
          echo "IDEO_JWT_SECRET=${{ secrets.PROD_IDEO_JWT_SECRET }}" >> $GITHUB_OUTPUT
          echo "$delimiter" >> $GITHUB_OUTPUT

  # STAGE 3: Release (dev → staging → production)
  release:
    needs: [build, test-auth, test-auth-db, test-auth-jwt, test-workflow, test-integration, test-refinement-lifecycle-approved, test-refinement-lifecycle-rejected, prepare-secrets]
    if: github.ref == 'refs/heads/main'
    uses: arun4infra/zerotouch-platform/.github/workflows/release-pipeline.yml@main
    with:
      service_name: ide-orchestrator
      image_tag: ${{ needs.build.outputs.image_tag }}
    secrets:
      BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
      BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      DEV_SECRETS_BLOB: ${{ needs.prepare-secrets.outputs.dev_blob }}
      STAGING_SECRETS_BLOB: ${{ needs.prepare-secrets.outputs.staging_blob }}
      PROD_SECRETS_BLOB: ${{ needs.prepare-secrets.outputs.prod_blob }}